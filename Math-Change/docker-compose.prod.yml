version: '3.8'

services:
  backend_api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: sumas-backend
    restart: always
    environment:
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_KEY=${SUPABASE_KEY}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - SECRET_KEY=${SECRET_KEY:-supersecretkey_change_me}
    networks:
      - default
      - traefik_proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik_proxy"
      - "traefik.http.routers.sumas-api.rule=Host(`sumas.n8nprueba.shop`) && PathPrefix(`/api`, `/docs`, `/redoc`, `/openapi.json`)"
      - "traefik.http.routers.sumas-api.entrypoints=websecure"
      - "traefik.http.routers.sumas-api.tls.certresolver=letsencrypt"
      - "traefik.http.routers.sumas-api.priority=100"
      - "traefik.http.services.sumas-api.loadbalancer.server.port=8000"

  frontend_app:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: sumas-frontend
    restart: always
    depends_on:
      - backend_api
    networks:
      - default
      - traefik_proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik_proxy"
      - "traefik.http.routers.sumas-web.rule=Host(`sumas.n8nprueba.shop`)"
      - "traefik.http.routers.sumas-web.entrypoints=websecure"
      - "traefik.http.routers.sumas-web.tls.certresolver=letsencrypt"
      - "traefik.http.routers.sumas-web.priority=1"
      - "traefik.http.services.sumas-web.loadbalancer.server.port=80"

networks:
  traefik_proxy:
    external: true
